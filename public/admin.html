<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nomability Admin</title>
  <link rel="stylesheet" href="nomability.css">
  <script defer src="nomability.js"></script>
  <script defer src="nomability-auth.js"></script>
</head>
<body>
  <header class="nm-header">
    <div class="nm-wrap nm-nav">
      <a class="nm-logo" href="/">Nomability</a>
      <nav class="nm-nav-links" aria-label="Primary">
        <a href="/">Home</a>
        <a href="/index.html#product">Product</a>
        <a href="pricing.html">Pricing</a>
        <a href="app.html">Studio</a>
      </nav>
      <div class="nm-nav-actions">
        <a class="nm-btn nm-btn-ghost" href="profile.html">Account</a>
        <div class="nm-auth-actions">
          <a class="nm-btn nm-btn-ghost" href="login.html" data-auth-open="login" data-auth-show="logged-out">Login</a>
          <a class="nm-btn nm-btn-primary" href="register.html" data-auth-open="register" data-auth-show="logged-out">Register</a>
          <div class="nm-profile" data-auth-profile data-auth-show="logged-in" hidden>
            <button class="nm-avatar" type="button" data-auth-avatar aria-haspopup="menu" aria-expanded="false">
              <span data-auth-initials>U</span>
            </button>
            <div class="nm-profile-menu" data-auth-menu role="menu" hidden>
              <div class="nm-profile-meta">
                <span class="nm-profile-name" data-auth-name>Account</span>
                <span class="nm-profile-email" data-auth-email></span>
              </div>
              <div class="nm-divider"></div>
              <a href="profile.html" role="menuitem">Account</a>
              <a href="profile.html" role="menuitem">Profile</a>
              <a href="profile.html" role="menuitem">Settings</a>
              <a href="profile.html" role="menuitem">Billing</a>
              <button type="button" id="logout" data-auth-logout role="menuitem">Log out</button>
            </div>
          </div>
        </div>
      </div>
      <button class="nm-nav-toggle" type="button" aria-label="Toggle menu" aria-expanded="false" data-nav-toggle>
        Menu
      </button>
    </div>
    <div class="nm-nav-mobile" data-nav-menu>
      <a href="/">Home</a>
      <a href="/index.html#product">Product</a>
      <a href="pricing.html">Pricing</a>
      <a href="profile.html">Account</a>
      <div class="nm-nav-mobile-auth">
        <a class="nm-btn nm-btn-ghost" href="login.html" data-auth-open="login" data-auth-show="logged-out">Login</a>
        <a class="nm-btn nm-btn-primary" href="register.html" data-auth-open="register" data-auth-show="logged-out">Register</a>
        <a class="nm-btn nm-btn-ghost" href="profile.html" data-auth-show="logged-in" hidden>Account</a>
        <a class="nm-btn nm-btn-ghost" href="profile.html" data-auth-show="logged-in" hidden>Profile</a>
        <button class="nm-btn nm-btn-ghost" type="button" data-auth-logout data-auth-show="logged-in" hidden>Log out</button>
      </div>
    </div>
  </header>

  <main class="nm-app-shell">
    <div class="nm-wrap nm-app-grid">
      <section class="nm-panel">
        <h2>Team members</h2>
        <div id="members" class="nm-help">Loading members...</div>
      </section>
      <section class="nm-panel">
        <h2>Invoice approvals</h2>
        <p id="invoice-status" class="nm-help" style="margin-top: -8px;"></p>
        <div id="invoice-approvals" class="nm-help">Loading invoices...</div>
      </section>
      <section class="nm-panel">
        <h2>Invite member</h2>
        <form id="invite-form" class="nm-grid" style="gap: 16px;">
          <div class="nm-field">
            <label for="invite-email">Email</label>
            <input id="invite-email" class="nm-input" type="email" required />
          </div>
          <div class="nm-field">
            <label for="invite-role">Role</label>
            <select id="invite-role" class="nm-select">
              <option value="member">Member</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button class="nm-btn nm-btn-primary" type="submit">Send invite</button>
        </form>
        <p id="invite-status" class="nm-help" style="margin-top: 12px;"></p>
      </section>
    </div>
  </main>

  <script>
    let headers = { 'Content-Type': 'application/json' };
    const membersEl = document.getElementById('members');
    const inviteStatus = document.getElementById('invite-status');
    const invoiceApprovals = document.getElementById('invoice-approvals');
    const invoiceStatus = document.getElementById('invoice-status');

    const formatDate = (value) => {
      if (!value) return '—';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '—';
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    const formatCurrency = (amount, currency = 'EUR') => {
      if (amount == null || Number.isNaN(amount)) return '—';
      return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount);
    };

    const redirectToLogin = () => {
      window.location.href = 'login.html?redirect=admin.html';
    };

    const redirectUnauthorized = () => {
      window.location.href = 'profile.html';
    };

    const requireAdmin = async () => {
      const token = localStorage.getItem('nmAuthToken');
      if (!token) {
        redirectToLogin();
        return false;
      }
      try {
        const response = await fetch('/api/auth/me', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (response.status === 401 || response.status === 403) {
          localStorage.removeItem('nmAuthToken');
          redirectToLogin();
          return false;
        }
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          redirectToLogin();
          return false;
        }
        if (data.membership?.role !== 'admin') {
          redirectUnauthorized();
          return false;
        }
        headers = { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' };
        return true;
      } catch (error) {
        redirectToLogin();
        return false;
      }
    };

    const loadMembers = async () => {
      const response = await fetch('/api/admin/org/members', { headers });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        membersEl.textContent = data.error || 'Failed to load members.';
        return;
      }
      if (!data.members?.length) {
        membersEl.textContent = 'No members yet.';
        return;
      }
      membersEl.innerHTML = '';
      data.members.forEach((member) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.marginBottom = '10px';

        const label = document.createElement('div');
        label.textContent = `${member.user.email} — ${member.role}`;
        row.appendChild(label);

        if (member.role !== 'owner') {
          const removeBtn = document.createElement('button');
          removeBtn.className = 'nm-btn nm-btn-ghost';
          removeBtn.type = 'button';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', async () => {
            const response = await fetch(`/api/admin/org/members/${member.id}`, { method: 'DELETE', headers });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
              membersEl.textContent = data.error || 'Failed to remove member.';
              return;
            }
            loadMembers();
          });
          row.appendChild(removeBtn);
        }

        membersEl.appendChild(row);
      });
    };

    const renderInvoices = (invoices) => {
      if (!invoiceApprovals) return;
      if (!invoices?.length) {
        invoiceApprovals.textContent = 'No invoice requests yet.';
        return;
      }

      invoiceApprovals.innerHTML = '';
      invoices.forEach((invoice) => {
        const status = invoice.status || 'pending';
        const currency = invoice.currency ? String(invoice.currency).toUpperCase() : 'EUR';
        const amount = formatCurrency((invoice.amountCents || 0) / 100, currency);
        const requestedBy = invoice.user?.email || invoice.billingName || 'Unknown';
        const createdAt = formatDate(invoice.createdAt);
        const dueDate = formatDate(invoice.dueDate);

        const item = document.createElement('div');
        item.className = 'nm-invoice-item';

        const title = document.createElement('div');
        title.className = 'nm-invoice-title';
        title.textContent = `${invoice.invoiceNumber} · ${invoice.planKey} · ${amount}`;

        const meta = document.createElement('div');
        meta.className = 'nm-invoice-meta';
        meta.textContent = `Requested by ${requestedBy} · Created ${createdAt} · Due ${dueDate}`;

        item.appendChild(title);
        item.appendChild(meta);

        if (status === 'pending') {
          const actions = document.createElement('div');
          actions.className = 'nm-inline-actions';

          const paidBtn = document.createElement('button');
          paidBtn.className = 'nm-btn nm-btn-primary nm-btn-sm';
          paidBtn.type = 'button';
          paidBtn.textContent = 'Mark paid';
          paidBtn.addEventListener('click', async () => {
            if (invoiceStatus) invoiceStatus.textContent = 'Updating invoice...';
            const response = await fetch(`/api/admin/org/invoices/${invoice.id}`, {
              method: 'POST',
              headers,
              body: JSON.stringify({ status: 'paid' })
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
              if (invoiceStatus) invoiceStatus.textContent = data.error || 'Failed to update invoice.';
              return;
            }
            if (invoiceStatus) invoiceStatus.textContent = 'Invoice updated.';
            loadInvoices();
          });

          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'nm-btn nm-btn-ghost nm-btn-sm';
          rejectBtn.type = 'button';
          rejectBtn.textContent = 'Reject';
          rejectBtn.addEventListener('click', async () => {
            if (invoiceStatus) invoiceStatus.textContent = 'Updating invoice...';
            const response = await fetch(`/api/admin/org/invoices/${invoice.id}`, {
              method: 'POST',
              headers,
              body: JSON.stringify({ status: 'rejected' })
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
              if (invoiceStatus) invoiceStatus.textContent = data.error || 'Failed to update invoice.';
              return;
            }
            if (invoiceStatus) invoiceStatus.textContent = 'Invoice updated.';
            loadInvoices();
          });

          actions.appendChild(paidBtn);
          actions.appendChild(rejectBtn);
          item.appendChild(actions);
        } else {
          const statusEl = document.createElement('div');
          statusEl.className = 'nm-help';
          statusEl.textContent = `Status: ${status}`;
          item.appendChild(statusEl);
        }

        invoiceApprovals.appendChild(item);
      });
    };

    const loadInvoices = async () => {
      if (!invoiceApprovals) return;
      const response = await fetch('/api/admin/org/invoices', { headers });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        invoiceApprovals.textContent = data.error || 'Failed to load invoices.';
        return;
      }
      renderInvoices(data.invoices || []);
    };

    document.getElementById('invite-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      inviteStatus.textContent = 'Sending invite...';
      const email = document.getElementById('invite-email').value.trim();
      const role = document.getElementById('invite-role').value;
      const response = await fetch('/api/admin/org/invite', {
        method: 'POST',
        headers,
        body: JSON.stringify({ email, role })
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        inviteStatus.textContent = data.error || 'Invite failed.';
        return;
      }
      inviteStatus.textContent = 'Invite sent.';
      loadMembers();
    });

    document.querySelectorAll('[data-auth-logout]').forEach((btn) => {
      btn.addEventListener('click', () => {
        localStorage.removeItem('nmAuthToken');
        window.location.href = 'login.html';
      });
    });

    const init = async () => {
      const ok = await requireAdmin();
      if (!ok) return;
      loadMembers();
      loadInvoices();
    };

    init();
  </script>
</body>
</html>
